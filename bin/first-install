#!/bin/bash

set -e
DIR=$(dirname "$(realpath "$BASH_SOURCE")")
source "$DIR/.common"
cd "$DIR/.."

ADMIN="admin"
ADMIN_DEV="admin-dev"
LOCK="install.lock"

echo "Checking for $PS_FOLDER_INSTALL dir..."

if [ -e $PS_FOLDER_INSTALL -a -d $PS_FOLDER_INSTALL ]
    then
        if [ -e $LOCK -a -f $LOCK ]
            then
                cmd rm $LOCK
        fi
        echo "Launching the installer script. Installation might take a litle while..."
        echo "php /var/www/html/$PS_FOLDER_INSTALL/index_cli.php \
        --domain="$PS_DOMAIN" --db_server=$DB_SERVER:$DB_PORT --db_name="$DB_NAME" --db_user=$DB_USER \
        --db_password=$DB_PASSWD --prefix="$DB_PREFIX" --firstname="Henri" --lastname="Baeyens" \
        --password="$ADMIN_PASSWD" --email="$ADMIN_MAIL" --language=$PS_LANGUAGE --country=$PS_COUNTRY \
        --all_languages=$PS_ALL_LANGUAGES --newsletter=0 --send_email=0 --ssl=$PS_ENABLE_SSL"
        
        php /var/www/html/$PS_FOLDER_INSTALL/index_cli.php \
        --domain="$PS_DOMAIN" --db_server=$DB_SERVER:$DB_PORT --db_name="$DB_NAME" --db_user=$DB_USER \
        --db_password=$DB_PASSWD --prefix="$DB_PREFIX" --firstname="Henri" --lastname="Baeyens" \
        --password="$ADMIN_PASSWD" --email="$ADMIN_MAIL" --language=$PS_LANGUAGE --country=$PS_COUNTRY \
        --all_languages=$PS_ALL_LANGUAGES --newsletter=0 --send_email=0 --ssl=$PS_ENABLE_SSL

        mysql -h $DB_SERVER -u $DB_USER -e "UPDATE `ps_configuration` SET `value` = '1' WHERE `ps_configuration`.`name` = 'PS_SSL_ENABLED';"
        mysql -h $DB_SERVER -u $DB_USER -e "UPDATE `ps_configuration` SET `value` = '1' WHERE `ps_configuration`.`name` = 'PS_SSL_ENABLED_EVERYWHERE';"

        cmd rm -Rf $PS_FOLDER_INSTALL
fi


